<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZARNS Monitor - Sistema de Acompanhamento</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3730a3;
            --primary-dark: #1e1b4b;
            --secondary: #7c3aed;
            --success: #059669;
            --danger: #dc2626;
            --warning: #d97706;
            --info: #0891b2;
            --dark: #1e293b;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--dark) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            background: var(--primary);
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 0;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-600);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: var(--gray-900);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(55, 48, 163, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            padding: 1rem;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 0.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-400);
            cursor: pointer;
            width: 32px;
            height: 32px;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--gray-50);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--gray-200);
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.875rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        .notification {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--gray-900);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .grade-input {
            width: 80px;
            text-align: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 2rem 0;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }

        .attendance-grid {
            display: grid;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 0.375rem;
        }

        .attendance-status {
            display: flex;
            gap: 0.5rem;
        }

        .attendance-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .attendance-btn.active {
            color: white;
        }

        .attendance-btn.present.active {
            background: var(--success);
        }

        .attendance-btn.absent.active {
            background: var(--danger);
        }

        .attendance-record {
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ZARNS Monitor</h1>
            <p style="opacity: 0.8; font-size: 0.875rem;">Sistema de Acompanhamento de Evolução</p>
        </div>
    </div>

    <div class="container">
        <!-- Estatísticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalStudents">0</div>
                <div class="stat-label">Total de Alunos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalEvaluations">0</div>
                <div class="stat-label">Avaliações Realizadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgLastEval">-</div>
                <div class="stat-label">Média Última Avaliação</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgAttendance">-</div>
                <div class="stat-label">Frequência Média (%)</div>
            </div>
        </div>

        <!-- Botões de Ação -->
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
            <button class="btn" onclick="showModal('addStudentModal')">Adicionar Aluno</button>
            <button class="btn btn-success" onclick="showModal('evaluationModal')">Lançar Avaliação</button>
            <button class="btn" onclick="showModal('attendanceModal')">Registrar Presença</button>
            <button class="btn" onclick="exportData()">Exportar Dados</button>
            <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
            <button class="btn" onclick="document.getElementById('importFile').click()">Importar Dados</button>
            <button class="btn btn-danger" onclick="clearAllData()">Limpar Todos os Dados</button>
        </div>

        <!-- Gráficos -->
        <div class="chart-grid">
            <div class="card">
                <h3>Evolução das Médias</h3>
                <div class="chart-container">
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3>Desempenho por Disciplina</h3>
                <div class="chart-container">
                    <canvas id="disciplineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('students')">Alunos</button>
            <button class="tab" onclick="switchTab('evaluations')">Avaliações</button>
            <button class="tab" onclick="switchTab('attendance')">Frequência</button>
            <button class="tab" onclick="switchTab('groups')">Análise por Grupos</button>
            <button class="tab" onclick="switchTab('individual')">Análise Individual</button>
        </div>

        <!-- Tab: Alunos -->
        <div class="tab-content active" id="students-tab">
            <div class="card">
                <h3>Alunos Cadastrados</h3>
                <div id="studentsTableContainer" style="margin-top: 1rem;">
                    <table id="studentsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Grupo</th>
                                <th>Avaliações</th>
                                <th>Última Média</th>
                                <th>Frequência</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody"></tbody>
                    </table>
                    <div id="emptyStudents" class="empty-state">
                        <p>Nenhum aluno cadastrado ainda.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Avaliações -->
        <div class="tab-content" id="evaluations-tab">
            <div class="card">
                <h3>Histórico de Avaliações</h3>
                <div id="evaluationsHistory" style="margin-top: 1rem;"></div>
            </div>
        </div>

        <!-- Tab: Frequência -->
        <div class="tab-content" id="attendance-tab">
            <div class="card">
                <h3>Registros de Presença</h3>
                <div id="attendanceHistory" style="margin-top: 1rem;"></div>
            </div>
        </div>

        <!-- Tab: Análise por Grupos -->
        <div class="tab-content" id="groups-tab">
            <div class="card">
                <h3>Análise Comparativa por Grupos</h3>
                <div class="chart-grid">
                    <div>
                        <h4>Evolução das Médias por Grupo</h4>
                        <div class="chart-container">
                            <canvas id="groupEvolutionChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4>Desempenho Atual por Grupo</h4>
                        <div class="chart-container">
                            <canvas id="groupComparisonChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 2rem;">
                    <h4>Frequência por Grupo</h4>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="groupAttendanceChart"></canvas>
                    </div>
                </div>
                
                <div id="groupStats" style="margin-top: 2rem;"></div>
            </div>
        </div>

        <!-- Tab: Análise Individual -->
        <div class="tab-content" id="individual-tab">
            <div class="card">
                <h3>Análise Individual do Aluno</h3>
                <div class="form-group">
                    <label class="form-label">Selecione o Aluno</label>
                    <select class="form-control" id="individualSelect" onchange="updateIndividualAnalysis()">
                        <option value="">Escolha um aluno...</option>
                    </select>
                </div>
                <div id="individualAnalysis"></div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Aluno -->
    <div class="modal" id="addStudentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Adicionar Aluno</h2>
                <button class="modal-close" onclick="closeModal('addStudentModal')">&times;</button>
            </div>
            <form onsubmit="saveStudent(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nome</label>
                        <input type="text" class="form-control" id="studentName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grupo</label>
                        <select class="form-control" id="studentGroup" required>
                            <option value="A">Grupo A</option>
                            <option value="B">Grupo B</option>
                            <option value="C">Grupo C</option>
                            <option value="D">Grupo D</option>
                            <option value="E">Grupo E</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('addStudentModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Lançar Avaliação -->
    <div class="modal" id="evaluationModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Lançar Avaliação</h2>
                <button class="modal-close" onclick="closeModal('evaluationModal')">&times;</button>
            </div>
            <form onsubmit="launchEvaluation(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nome da Avaliação</label>
                        <input type="text" class="form-control" id="evaluationName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data</label>
                        <input type="date" class="form-control" id="evaluationDate" required>
                    </div>
                    <div id="evaluationStudentsList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('evaluationModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Avaliação</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Registrar Presença -->
    <div class="modal" id="attendanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Registrar Presença</h2>
                <button class="modal-close" onclick="closeModal('attendanceModal')">&times;</button>
            </div>
            <form onsubmit="saveAttendance(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Data</label>
                        <input type="date" class="form-control" id="attendanceDate" required>
                    </div>
                    <div id="attendanceList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('attendanceModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Presença</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Dados
        let students = [];
        let evaluations = [];
        let attendanceRecords = [];
        let charts = {};
        const disciplines = ['Clínica Médica', 'Cirurgia', 'Gineco-Obstetrícia', 'Pediatria', 'MFC/SC', 'Saúde Mental'];

        // Carregar dados do localStorage
        function loadData() {
            const saved = localStorage.getItem('zarns_data');
            if (saved) {
                const data = JSON.parse(saved);
                students = data.students || [];
                evaluations = data.evaluations || [];
                attendanceRecords = data.attendanceRecords || [];
            }
            renderAll();
            updateCharts();
        }

        // Salvar dados no localStorage
        function saveData() {
            const data = { students, evaluations, attendanceRecords };
            localStorage.setItem('zarns_data', JSON.stringify(data));
        }

        // Renderizar tudo
        function renderAll() {
            renderStudents();
            renderStats();
            renderEvaluations();
            renderAttendance();
            updateIndividualSelect();
        }

        // Renderizar estatísticas
        function renderStats() {
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('totalEvaluations').textContent = evaluations.length;

            // Média da última avaliação
            if (evaluations.length > 0) {
                const lastEval = evaluations[evaluations.length - 1];
                let totalAvg = 0;
                let count = 0;

                for (const studentId in lastEval.grades) {
                    const grades = lastEval.grades[studentId];
                    const avg = grades.reduce((a, b) => a + b, 0) / grades.length;
                    totalAvg += avg;
                    count++;
                }

                if (count > 0) {
                    document.getElementById('avgLastEval').textContent = (totalAvg / count).toFixed(1);
                }
            }

            // Frequência média
            if (attendanceRecords.length > 0 && students.length > 0) {
                let totalPresences = 0;
                let totalPossible = 0;

                attendanceRecords.forEach(record => {
                    students.forEach(student => {
                        if (record.attendance[student.id]) {
                            totalPossible++;
                            if (record.attendance[student.id] === 'present') {
                                totalPresences++;
                            }
                        }
                    });
                });

                if (totalPossible > 0) {
                    const avgAttendance = (totalPresences / totalPossible * 100).toFixed(1);
                    document.getElementById('avgAttendance').textContent = avgAttendance;
                }
            }
        }

        // Renderizar alunos
        function renderStudents() {
            const tbody = document.getElementById('studentsTableBody');
            const table = document.getElementById('studentsTable');
            const empty = document.getElementById('emptyStudents');

            if (students.length === 0) {
                table.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            empty.style.display = 'none';

            tbody.innerHTML = students.map(student => {
                const studentEvals = evaluations.filter(e => e.grades[student.id]);
                const lastEval = studentEvals[studentEvals.length - 1];
                let lastAvg = '-';

                if (lastEval && lastEval.grades[student.id]) {
                    const grades = lastEval.grades[student.id];
                    lastAvg = (grades.reduce((a, b) => a + b, 0) / grades.length).toFixed(1);
                }

                // Calcular frequência
                let presences = 0;
                let total = 0;
                attendanceRecords.forEach(record => {
                    if (record.attendance[student.id]) {
                        total++;
                        if (record.attendance[student.id] === 'present') {
                            presences++;
                        }
                    }
                });
                const attendance = total > 0 ? ((presences / total) * 100).toFixed(0) + '%' : '-';

                return `
                    <tr>
                        <td>${student.name}</td>
                        <td>Grupo ${student.group}</td>
                        <td>${studentEvals.length}</td>
                        <td>${lastAvg}</td>
                        <td>${attendance}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="removeStudent(${student.id})">Remover</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Renderizar avaliações
        function renderEvaluations() {
            const container = document.getElementById('evaluationsHistory');

            if (evaluations.length === 0) {
                container.innerHTML = '<p class="empty-state">Nenhuma avaliação realizada ainda.</p>';
                return;
            }

            container.innerHTML = evaluations.slice().reverse().map(eval => {
                let avgTotal = 0;
                let count = 0;

                const studentRows = students.map(student => {
                    if (eval.grades[student.id]) {
                        const grades = eval.grades[student.id];
                        const avg = grades.reduce((a, b) => a + b, 0) / grades.length;
                        avgTotal += avg;
                        count++;

                        const gradeDetails = disciplines.map((disc, i) => 
                            `${disc}: ${grades[i].toFixed(1)}`
                        ).join(' | ');

                        return `
                            <tr>
                                <td>${student.name}</td>
                                <td>${avg.toFixed(1)}</td>
                                <td style="font-size: 0.75rem; color: var(--gray-600);">${gradeDetails}</td>
                            </tr>
                        `;
                    }
                    return null;
                }).filter(Boolean).join('');

                const classAvg = count > 0 ? (avgTotal / count).toFixed(1) : '-';

                return `
                    <div class="attendance-record">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <strong>${eval.name}</strong>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="color: var(--gray-600); font-size: 0.875rem;">${new Date(eval.date).toLocaleDateString('pt-BR')}</span>
                                <button class="btn btn-sm" onclick="editEvaluation(${eval.id})">Editar</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteEvaluation(${eval.id})">Excluir</button>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            Média da turma: <strong style="font-size: 1.25rem; color: var(--primary);">${classAvg}</strong>
                        </div>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Aluno</th>
                                    <th>Média</th>
                                    <th>Notas por Disciplina</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${studentRows}
                            </tbody>
                        </table>
                    </div>
                `;
            }).join('');
        }

        // Renderizar frequência
        function renderAttendance() {
            const container = document.getElementById('attendanceHistory');

            if (attendanceRecords.length === 0) {
                container.innerHTML = '<p class="empty-state">Nenhum registro de presença ainda.</p>';
                return;
            }

            container.innerHTML = attendanceRecords.slice().reverse().map(record => {
                let presentes = 0;
                let ausentes = 0;

                const studentList = students.map(student => {
                    const status = record.attendance[student.id];
                    if (status === 'present') presentes++;
                    else if (status === 'absent') ausentes++;

                    const badge = status === 'present' ? 
                        '<span class="badge badge-success">Presente</span>' :
                        '<span class="badge badge-danger">Ausente</span>';

                    return status ? `<li>${student.name}: ${badge}</li>` : '';
                }).filter(Boolean).join('');

                return `
                    <div class="attendance-record">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong>${new Date(record.date).toLocaleDateString('pt-BR')}</strong>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div>
                                    <span style="color: var(--success); margin-right: 1rem;">Presentes: ${presentes}</span>
                                    <span style="color: var(--danger);">Ausentes: ${ausentes}</span>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="deleteAttendance(${record.id})">Excluir</button>
                            </div>
                        </div>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            ${studentList}
                        </ul>
                    </div>
                `;
            }).join('');
        }

        // Atualizar select de análise individual
        function updateIndividualSelect() {
            const select = document.getElementById('individualSelect');
            select.innerHTML = '<option value="">Escolha um aluno...</option>' +
                students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        // Atualizar análise individual
        function updateIndividualAnalysis() {
            const studentId = parseInt(document.getElementById('individualSelect').value);
            const container = document.getElementById('individualAnalysis');

            if (!studentId) {
                container.innerHTML = '';
                return;
            }

            const student = students.find(s => s.id === studentId);
            const studentEvals = evaluations.filter(e => e.grades[studentId]);

            // Calcular estatísticas
            let allGrades = [];
            let gradesByDiscipline = {};
            disciplines.forEach(d => gradesByDiscipline[d] = []);

            studentEvals.forEach(eval => {
                const grades = eval.grades[studentId];
                grades.forEach((grade, i) => {
                    allGrades.push(grade);
                    gradesByDiscipline[disciplines[i]].push(grade);
                });
            });

            const overallAvg = allGrades.length > 0 ? 
                (allGrades.reduce((a, b) => a + b, 0) / allGrades.length).toFixed(1) : '-';

            // Calcular frequência
            let presences = 0;
            let total = 0;
            attendanceRecords.forEach(record => {
                if (record.attendance[studentId]) {
                    total++;
                    if (record.attendance[studentId] === 'present') {
                        presences++;
                    }
                }
            });
            const attendanceRate = total > 0 ? ((presences / total) * 100).toFixed(0) : 0;

            // Gerar HTML
            container.innerHTML = `
                <div style="margin-top: 2rem;">
                    <h4>${student.name} - Grupo ${student.group}</h4>
                    
                    <div class="stats-grid" style="margin: 2rem 0;">
                        <div class="stat-card">
                            <div class="stat-value">${overallAvg}</div>
                            <div class="stat-label">Média Geral</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${attendanceRate}%</div>
                            <div class="stat-label">Frequência</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${studentEvals.length}</div>
                            <div class="stat-label">Avaliações</div>
                        </div>
                    </div>

                    <h5>Médias por Disciplina</h5>
                    <table style="margin-top: 1rem;">
                        <thead>
                            <tr>
                                <th>Disciplina</th>
                                <th>Média</th>
                                <th>Avaliações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${disciplines.map(disc => {
                                const grades = gradesByDiscipline[disc];
                                const avg = grades.length > 0 ?
                                    (grades.reduce((a, b) => a + b, 0) / grades.length).toFixed(1) : '-';
                                return `
                                    <tr>
                                        <td>${disc}</td>
                                        <td>${avg}</td>
                                        <td>${grades.length}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    <h5 style="margin-top: 2rem;">Evolução nas Avaliações</h5>
                    <div class="chart-container">
                        <canvas id="individualChart"></canvas>
                    </div>
                </div>
            `;

            // Criar gráfico individual
            if (charts.individual) {
                charts.individual.destroy();
            }

            const ctx = document.getElementById('individualChart').getContext('2d');
            const labels = studentEvals.map(e => e.name);
            const data = studentEvals.map(e => {
                const grades = e.grades[studentId];
                return grades.reduce((a, b) => a + b, 0) / grades.length;
            });

            charts.individual = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Média',
                        data: data,
                        borderColor: 'rgb(55, 48, 163)',
                        backgroundColor: 'rgba(55, 48, 163, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10
                        }
                    }
                }
            });
        }

        // Adicionar aluno
        function saveStudent(event) {
            event.preventDefault();
            
            const name = document.getElementById('studentName').value;
            const group = document.getElementById('studentGroup').value;

            const newStudent = {
                id: Date.now(),
                name,
                group
            };

            students.push(newStudent);
            saveData();
            renderAll();
            updateCharts();
            closeModal('addStudentModal');
            showNotification('Aluno adicionado com sucesso!');

            // Limpar formulário
            document.getElementById('studentName').value = '';
            document.getElementById('studentGroup').value = 'A';
        }

        // Remover aluno
        function removeStudent(id) {
            if (confirm('Tem certeza que deseja remover este aluno?')) {
                students = students.filter(s => s.id !== id);
                saveData();
                renderAll();
                updateCharts();
                showNotification('Aluno removido com sucesso!');
            }
        }

        // Lançar avaliação
        function launchEvaluation(event) {
            event.preventDefault();

            const name = document.getElementById('evaluationName').value;
            const date = document.getElementById('evaluationDate').value;

            const newEval = {
                id: Date.now(),
                name,
                date,
                grades: {}
            };

            // Coletar notas
            students.forEach(student => {
                const grades = [];
                disciplines.forEach((disc, index) => {
                    const input = document.getElementById(`grade_${student.id}_${index}`);
                    if (input) {
                        grades.push(parseFloat(input.value) || 0);
                    }
                });
                newEval.grades[student.id] = grades;
            });

            evaluations.push(newEval);
            saveData();
            renderAll();
            updateCharts();
            closeModal('evaluationModal');
            showNotification('Avaliação lançada com sucesso!');
        }

        // Salvar presença
        function saveAttendance(event) {
            event.preventDefault();

            const date = document.getElementById('attendanceDate').value;
            const attendance = {};

            students.forEach(student => {
                const presentBtn = document.querySelector(`#attendance_${student.id}_present`);
                const absentBtn = document.querySelector(`#attendance_${student.id}_absent`);
                
                if (presentBtn && presentBtn.classList.contains('active')) {
                    attendance[student.id] = 'present';
                } else if (absentBtn && absentBtn.classList.contains('active')) {
                    attendance[student.id] = 'absent';
                }
            });

            const newRecord = {
                id: Date.now(),
                date,
                attendance
            };

            attendanceRecords.push(newRecord);
            saveData();
            renderAll();
            closeModal('attendanceModal');
            showNotification('Presença registrada com sucesso!');
        }

        // Toggle presença
        function toggleAttendance(studentId, status) {
            const presentBtn = document.querySelector(`#attendance_${studentId}_present`);
            const absentBtn = document.querySelector(`#attendance_${studentId}_absent`);

            presentBtn.classList.remove('active');
            absentBtn.classList.remove('active');

            if (status === 'present') {
                presentBtn.classList.add('active');
            } else {
                absentBtn.classList.add('active');
            }
        }

        // Mostrar modal
        function showModal(modalId) {
            if (modalId === 'evaluationModal') {
                renderEvaluationForm();
            } else if (modalId === 'attendanceModal') {
                renderAttendanceForm();
            }
            document.getElementById(modalId).classList.add('active');
        }

        // Fechar modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Renderizar formulário de avaliação
        function renderEvaluationForm() {
            const container = document.getElementById('evaluationStudentsList');

            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray-500); margin-top: 2rem;">Adicione alunos primeiro.</p>';
                return;
            }

            container.innerHTML = '<h4 style="margin-top: 1.5rem; margin-bottom: 1rem;">Notas por Disciplina:</h4>' +
                students.map(student => `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 0.375rem;">
                        <h5 style="margin-bottom: 0.75rem;">${student.name} (Grupo ${student.group})</h5>
                        <div class="form-grid">
                            ${disciplines.map((disc, index) => `
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--gray-600);">${disc}</label>
                                    <input type="number" 
                                           id="grade_${student.id}_${index}"
                                           class="form-control grade-input" 
                                           min="0" 
                                           max="10" 
                                           step="0.1"
                                           required>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
        }

        // Renderizar formulário de presença
        function renderAttendanceForm() {
            const container = document.getElementById('attendanceList');

            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray-500); margin-top: 2rem;">Adicione alunos primeiro.</p>';
                return;
            }

            container.innerHTML = '<div class="attendance-grid">' +
                students.map(student => `
                    <div class="attendance-item">
                        <span>${student.name}</span>
                        <div class="attendance-status">
                            <button type="button" 
                                    id="attendance_${student.id}_present"
                                    class="attendance-btn present active" 
                                    onclick="toggleAttendance(${student.id}, 'present')">
                                Presente
                            </button>
                            <button type="button" 
                                    id="attendance_${student.id}_absent"
                                    class="attendance-btn absent" 
                                    onclick="toggleAttendance(${student.id}, 'absent')">
                                Ausente
                            </button>
                        </div>
                    </div>
                `).join('') +
            '</div>';
        }

        // Switch tab
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Atualizar gráficos
        function updateCharts() {
            // Gráfico de evolução
            if (charts.evolution) {
                charts.evolution.destroy();
            }

            if (evaluations.length > 0) {
                const ctx1 = document.getElementById('evolutionChart').getContext('2d');
                const labels = evaluations.map(e => e.name);
                const data = evaluations.map(eval => {
                    let total = 0;
                    let count = 0;
                    for (const studentId in eval.grades) {
                        const grades = eval.grades[studentId];
                        total += grades.reduce((a, b) => a + b, 0) / grades.length;
                        count++;
                    }
                    return count > 0 ? total / count : 0;
                });

                charts.evolution = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Média da Turma',
                            data: data,
                            borderColor: 'rgb(55, 48, 163)',
                            backgroundColor: 'rgba(55, 48, 163, 0.1)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10
                            }
                        }
                    }
                });
            }

            // Gráfico por disciplina
            if (charts.discipline) {
                charts.discipline.destroy();
            }

            if (evaluations.length > 0) {
                const lastEval = evaluations[evaluations.length - 1];
                const avgByDiscipline = disciplines.map((disc, index) => {
                    let total = 0;
                    let count = 0;
                    for (const studentId in lastEval.grades) {
                        total += lastEval.grades[studentId][index];
                        count++;
                    }
                    return count > 0 ? total / count : 0;
                });

                const ctx2 = document.getElementById('disciplineChart').getContext('2d');
                charts.discipline = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: disciplines,
                        datasets: [{
                            label: 'Média por Disciplina',
                            data: avgByDiscipline,
                            backgroundColor: [
                                'rgba(55, 48, 163, 0.8)',
                                'rgba(124, 58, 237, 0.8)',
                                'rgba(5, 150, 105, 0.8)',
                                'rgba(220, 38, 38, 0.8)',
                                'rgba(217, 119, 6, 0.8)',
                                'rgba(8, 145, 178, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10
                            }
                        }
                    }
                });
            }

            // Atualizar gráficos de grupos
            updateGroupCharts();
        }

        // Atualizar gráficos de grupos
        function updateGroupCharts() {
            const groups = ['A', 'B', 'C', 'D', 'E'];
            
            // Gráfico de evolução por grupo
            if (charts.groupEvolution) {
                charts.groupEvolution.destroy();
            }

            if (evaluations.length > 0) {
                const ctx = document.getElementById('groupEvolutionChart').getContext('2d');
                const labels = evaluations.map(e => e.name);
                
                const datasets = groups.map((group, index) => {
                    const data = evaluations.map(eval => {
                        const groupStudents = students.filter(s => s.group === group);
                        let total = 0;
                        let count = 0;
                        
                        groupStudents.forEach(student => {
                            if (eval.grades[student.id]) {
                                const grades = eval.grades[student.id];
                                total += grades.reduce((a, b) => a + b, 0) / grades.length;
                                count++;
                            }
                        });
                        
                        return count > 0 ? total / count : null;
                    });

                    const colors = [
                        'rgb(55, 48, 163)',
                        'rgb(124, 58, 237)',
                        'rgb(5, 150, 105)',
                        'rgb(220, 38, 38)',
                        'rgb(217, 119, 6)'
                    ];

                    return {
                        label: `Grupo ${group}`,
                        data: data,
                        borderColor: colors[index],
                        backgroundColor: colors[index] + '33',
                        tension: 0.1
                    };
                }).filter(dataset => dataset.data.some(d => d !== null));

                charts.groupEvolution = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10
                            }
                        }
                    }
                });
            }

            // Gráfico de comparação atual por grupo
            if (charts.groupComparison) {
                charts.groupComparison.destroy();
            }

            if (evaluations.length > 0) {
                const ctx2 = document.getElementById('groupComparisonChart').getContext('2d');
                const lastEval = evaluations[evaluations.length - 1];
                
                const avgByGroup = groups.map(group => {
                    const groupStudents = students.filter(s => s.group === group);
                    let total = 0;
                    let count = 0;
                    
                    groupStudents.forEach(student => {
                        if (lastEval.grades[student.id]) {
                            const grades = lastEval.grades[student.id];
                            total += grades.reduce((a, b) => a + b, 0) / grades.length;
                            count++;
                        }
                    });
                    
                    return count > 0 ? total / count : 0;
                });

                charts.groupComparison = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: groups.map(g => `Grupo ${g}`),
                        datasets: [{
                            label: 'Média na Última Avaliação',
                            data: avgByGroup,
                            backgroundColor: [
                                'rgba(55, 48, 163, 0.8)',
                                'rgba(124, 58, 237, 0.8)',
                                'rgba(5, 150, 105, 0.8)',
                                'rgba(220, 38, 38, 0.8)',
                                'rgba(217, 119, 6, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10
                            }
                        }
                    }
                });
            }

            // Gráfico de frequência por grupo
            if (charts.groupAttendance) {
                charts.groupAttendance.destroy();
            }

            const ctx3 = document.getElementById('groupAttendanceChart').getContext('2d');
            const attendanceByGroup = groups.map(group => {
                const groupStudents = students.filter(s => s.group === group);
                let totalPresences = 0;
                let totalPossible = 0;
                
                groupStudents.forEach(student => {
                    attendanceRecords.forEach(record => {
                        if (record.attendance[student.id]) {
                            totalPossible++;
                            if (record.attendance[student.id] === 'present') {
                                totalPresences++;
                            }
                        }
                    });
                });
                
                return totalPossible > 0 ? (totalPresences / totalPossible * 100) : 0;
            });

            charts.groupAttendance = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: groups.map(g => `Grupo ${g}`),
                    datasets: [{
                        label: 'Frequência (%)',
                        data: attendanceByGroup,
                        backgroundColor: 'rgba(5, 150, 105, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Estatísticas por grupo
            updateGroupStats();
        }

        // Atualizar estatísticas por grupo
        function updateGroupStats() {
            const container = document.getElementById('groupStats');
            const groups = ['A', 'B', 'C', 'D', 'E'];
            
            const stats = groups.map(group => {
                const groupStudents = students.filter(s => s.group === group);
                if (groupStudents.length === 0) return null;
                
                // Calcular média geral do grupo
                let totalAvg = 0;
                let avgCount = 0;
                
                if (evaluations.length > 0) {
                    const lastEval = evaluations[evaluations.length - 1];
                    groupStudents.forEach(student => {
                        if (lastEval.grades[student.id]) {
                            const grades = lastEval.grades[student.id];
                            totalAvg += grades.reduce((a, b) => a + b, 0) / grades.length;
                            avgCount++;
                        }
                    });
                }
                
                const avgGrade = avgCount > 0 ? (totalAvg / avgCount).toFixed(1) : '-';
                
                // Calcular frequência
                let presences = 0;
                let total = 0;
                groupStudents.forEach(student => {
                    attendanceRecords.forEach(record => {
                        if (record.attendance[student.id]) {
                            total++;
                            if (record.attendance[student.id] === 'present') {
                                presences++;
                            }
                        }
                    });
                });
                
                const attendance = total > 0 ? ((presences / total) * 100).toFixed(0) : 0;
                
                return {
                    group,
                    students: groupStudents.length,
                    avgGrade,
                    attendance
                };
            }).filter(Boolean);

            container.innerHTML = `
                <h4>Resumo por Grupo</h4>
                <table style="margin-top: 1rem;">
                    <thead>
                        <tr>
                            <th>Grupo</th>
                            <th>Alunos</th>
                            <th>Média Última Avaliação</th>
                            <th>Frequência</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stats.map(stat => `
                            <tr>
                                <td>Grupo ${stat.group}</td>
                                <td>${stat.students}</td>
                                <td>${stat.avgGrade}</td>
                                <td>${stat.attendance}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Limpar todos os dados
        function clearAllData() {
            if (confirm('ATENÇÃO: Isso irá apagar TODOS os dados do sistema (alunos, avaliações e presenças). Deseja continuar?')) {
                if (confirm('Tem certeza absoluta? Esta ação não pode ser desfeita!')) {
                    students = [];
                    evaluations = [];
                    attendanceRecords = [];
                    saveData();
                    renderAll();
                    updateCharts();
                    showNotification('Todos os dados foram apagados!');
                }
            }
        }

        // Excluir avaliação
        function deleteEvaluation(id) {
            if (confirm('Tem certeza que deseja excluir esta avaliação?')) {
                evaluations = evaluations.filter(e => e.id !== id);
                saveData();
                renderAll();
                updateCharts();
                showNotification('Avaliação excluída com sucesso!');
            }
        }

        // Excluir registro de presença
        function deleteAttendance(id) {
            if (confirm('Tem certeza que deseja excluir este registro de presença?')) {
                attendanceRecords = attendanceRecords.filter(r => r.id !== id);
                saveData();
                renderAll();
                showNotification('Registro de presença excluído com sucesso!');
            }
        }

        // Editar avaliação
        function editEvaluation(id) {
            const evaluation = evaluations.find(e => e.id === id);
            if (!evaluation) return;

            // Preencher o formulário com os dados existentes
            document.getElementById('evaluationName').value = evaluation.name;
            document.getElementById('evaluationDate').value = evaluation.date;
            
            // Marcar como edição
            document.getElementById('evaluationModal').dataset.editId = id;
            
            showModal('evaluationModal');
            
            // Aguardar um momento para garantir que o formulário foi renderizado
            setTimeout(() => {
                // Preencher as notas existentes
                for (const studentId in evaluation.grades) {
                    const grades = evaluation.grades[studentId];
                    grades.forEach((grade, index) => {
                        const input = document.getElementById(`grade_${studentId}_${index}`);
                        if (input) {
                            input.value = grade;
                        }
                    });
                }
            }, 100);
        }

        // Modificar a função launchEvaluation para suportar edição
        function launchEvaluation(event) {
            event.preventDefault();

            const name = document.getElementById('evaluationName').value;
            const date = document.getElementById('evaluationDate').value;
            const editId = document.getElementById('evaluationModal').dataset.editId;

            const evalData = {
                name,
                date,
                grades: {}
            };

            // Coletar notas
            students.forEach(student => {
                const grades = [];
                disciplines.forEach((disc, index) => {
                    const input = document.getElementById(`grade_${student.id}_${index}`);
                    if (input) {
                        grades.push(parseFloat(input.value) || 0);
                    }
                });
                evalData.grades[student.id] = grades;
            });

            if (editId) {
                // Modo edição
                const index = evaluations.findIndex(e => e.id === parseInt(editId));
                if (index !== -1) {
                    evaluations[index] = { ...evaluations[index], ...evalData };
                }
                delete document.getElementById('evaluationModal').dataset.editId;
                showNotification('Avaliação atualizada com sucesso!');
            } else {
                // Modo criação
                const newEval = {
                    id: Date.now(),
                    ...evalData
                };
                evaluations.push(newEval);
                showNotification('Avaliação lançada com sucesso!');
            }

            saveData();
            renderAll();
            updateCharts();
            closeModal('evaluationModal');
            
            // Limpar formulário
            document.getElementById('evaluationName').value = '';
            document.getElementById('evaluationDate').value = '';
        }

        // Exportar dados
        function exportData() {
            const data = { students, evaluations, attendanceRecords };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zarns_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Dados exportados com sucesso!');
        }

        // Importar dados
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    students = data.students || [];
                    evaluations = data.evaluations || [];
                    attendanceRecords = data.attendanceRecords || [];
                    saveData();
                    renderAll();
                    updateCharts();
                    showNotification('Dados importados com sucesso!');
                } catch (error) {
                    alert('Erro ao importar arquivo. Verifique se é um arquivo válido.');
                }
            };
            reader.readAsText(file);
        }

        // Notificação
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Inicializar ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Inicializar gráficos vazios
            const ctx1 = document.getElementById('evolutionChart').getContext('2d');
            charts.evolution = new Chart(ctx1, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            const ctx2 = document.getElementById('disciplineChart').getContext('2d');
            charts.discipline = new Chart(ctx2, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Inicializar gráficos de grupos
            const ctx3 = document.getElementById('groupEvolutionChart').getContext('2d');
            charts.groupEvolution = new Chart(ctx3, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            const ctx4 = document.getElementById('groupComparisonChart').getContext('2d');
            charts.groupComparison = new Chart(ctx4, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            const ctx5 = document.getElementById('groupAttendanceChart').getContext('2d');
            charts.groupAttendance = new Chart(ctx5, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            updateCharts();
        });
    </script>
</body>
</html>